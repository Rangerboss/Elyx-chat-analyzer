<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elyx - Analysis Results</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
            background-color: #112328;
            color: #E9F2FF;
        }
        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.5;
        }
        .content {
            position: relative;
            z-index: 1;
            padding: 20px;
        }
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            position: relative;
        }
        .logo {
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(45deg, #3B8E97, #63D5D7, #8EBEBF, #D2F4FF);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 1.1rem;
            color: #B0CDDC;
        }
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .tab {
            padding: 14px 28px;
            background-color: rgba(37, 69, 79, 0.8);
            color: #E9F2FF;
            border: none;
            cursor: pointer;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tab.active {
            background: linear-gradient(45deg, #3B8E97, #63D5D780);
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(99, 213, 215, 0.3);
        }
        .tab:hover:not(.active) {
            background-color: rgba(59, 142, 151, 0.2);
            transform: translateY(-1px);
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .content-wrapper {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Card styles */
        .card {
            background: linear-gradient(135deg, rgba(37, 69, 79, 0.8), rgba(17, 35, 40, 0.8));
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            border: 1px solid rgba(142, 190, 191, 0.2);
            overflow: hidden;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #3B8E97, #63D5D7, #8EBEBF, #D2F4FF);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
        }
        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
            color: #E9F2FF;
        }
        .regenerate-btn {
            background: linear-gradient(90deg, #3B8E97, #63D5D7);
            color: #112328;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .regenerate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(99, 213, 215, 0.4);
        }
        .regenerate-btn svg {
            width: 16px;
            height: 16px;
        }
        
        /* Accordion for months */
        .month-accordion {
            margin-bottom: 10px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(142, 190, 191, 0.2);
            background-color: rgba(37, 69, 79, 0.5);
            transition: all 0.3s;
        }
        .month-accordion:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }
        .month-header {
            background-color: rgba(59, 142, 151, 0.2);
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            border-bottom: 1px solid rgba(142, 190, 191, 0.2);
            transition: background-color 0.3s;
        }
        .month-header:hover {
            background-color: rgba(59, 142, 151, 0.3);
        }
        .month-header-active {
            background-color: rgba(59, 142, 151, 0.4);
        }
        .month-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 20px;
        }
        .month-content-active {
            max-height: 800px;
            padding: 20px;
        }
        .month-toggle-icon {
            transition: transform 0.3s;
        }
        .month-toggle-icon-active {
            transform: rotate(180deg);
        }
        .detail-row {
            margin-bottom: 12px;
        }
        .detail-label {
            font-weight: 600;
            font-size: 0.85rem;
            color: #8EBEBF;
            margin-bottom: 3px;
        }
        .detail-value {
            font-size: 0.95rem;
        }
        
        /* Progress table */
        .progress-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-table thead th {
            background-color: rgba(59, 142, 151, 0.2);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #E9F2FF;
        }
        .progress-table tbody td {
            padding: 15px;
            border-bottom: 1px solid rgba(142, 190, 191, 0.1);
        }
        .progress-table tbody tr:last-child td {
            border-bottom: none;
        }
        .progress-table tbody tr:nth-child(odd) {
            background-color: rgba(37, 69, 79, 0.3);
        }
        .progress-table tbody tr:nth-child(even) {
            background-color: rgba(17, 35, 40, 0.3);
        }
        .status-improved {
            color: #63D5D7;
            font-weight: 600;
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            background-color: rgba(59, 142, 151, 0.2);
        }
        
        /* Decision cards */
        .decision-card {
            background: linear-gradient(135deg, rgba(37, 69, 79, 0.7), rgba(17, 35, 40, 0.7));
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(142, 190, 191, 0.1);
        }
        .decision-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }
        .decision-badge {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-diagnostic {
            background-color: rgba(99, 213, 215, 0.2);
            color: #D2F4FF;
        }
        .badge-nutrition {
            background-color: rgba(59, 142, 151, 0.2);
            color: #8EBEBF;
        }
        .badge-cardio {
            background-color: rgba(176, 205, 220, 0.2);
            color: #E9F2FF;
        }
        .badge-medication {
            background-color: rgba(142, 190, 191, 0.2);
            color: #D2F4FF;
        }
        .decision-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }
        .decision-details {
            margin: 15px 0;
        }
        .timeline {
            display: flex;
            align-items: center;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .timeline-item {
            flex: 1;
            text-align: center;
            padding: 8px 4px;
            font-size: 0.8rem;
            position: relative;
        }
        .timeline-item:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -10px;
            width: 20px;
            height: 1px;
            background-color: rgba(255, 255, 255, 0.2);
        }
        .timeline-active {
            background-color: #3B8E97;
            color: #E9F2FF;
            font-weight: 600;
            border-radius: 4px;
        }
        
        /* Track table */
        .track-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }
        .track-table th {
            background-color: rgba(59, 142, 151, 0.3);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #E9F2FF;
        }
        .track-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(142, 190, 191, 0.1);
            color: #E9F2FF;
        }
        .track-table tbody tr:nth-child(odd) {
            background-color: rgba(37, 69, 79, 0.6);
        }
        .track-table tbody tr:nth-child(even) {
            background-color: rgba(17, 35, 40, 0.6);
        }
        .track-table .total-column {
            background-color: rgba(99, 213, 215, 0.2);
            font-weight: 600;
            color: #D2F4FF;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 16px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #63D5D7;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #ffffff;
        }
        
        /* Navigation buttons */
        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }
        .nav-btn {
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        .back-btn {
            background-color: rgba(59, 142, 151, 0.2);
            color: #E9F2FF;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .back-btn:hover {
            background-color: rgba(59, 142, 151, 0.3);
            transform: translateY(-2px);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .tabs {
                gap: 8px;
            }
            .tab {
                padding: 10px 16px;
                font-size: 14px;
            }
            .card {
                padding: 15px;
            }
            .track-table, .progress-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="background-container">
        <iframe src='https://my.spline.design/untitled-pgirDbd48dL7cxToZ2YLe963/' frameborder='0' width='100%' height='100%'></iframe>
    </div>
    
    <div class="content">
        <div class="content-wrapper">
            <header>
                <h1 class="logo">Elyx Analysis</h1>
                <p class="subtitle">Comprehensive Health Journey Insights</p>
            </header>
            
            <div class="tabs">
                <button class="tab active" data-tab="persona">Patient Persona</button>
                <button class="tab" data-tab="progress">Health Progress</button>
                <button class="tab" data-tab="decision">Decision Analysis</button>
                <button class="tab" data-tab="track">Resource Tracking</button>
            </div>
            
            <!-- Persona Tab -->
            <div id="persona-tab" class="tab-content active">
                <div class="card">
                    <div class="loading-overlay" id="persona-loading">
                        <div class="spinner"></div>
                        <p class="loading-text">Regenerating persona analysis...</p>
                    </div>
                    <div class="card-header">
                        <h2 class="card-title">Patient Persona Analysis</h2>
                        <button class="regenerate-btn" data-type="persona">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                            </svg>
                            Regenerate
                        </button>
                    </div>
                    <div id="persona-content">
                        <!-- Accordion will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Progress Tab -->
            <div id="progress-tab" class="tab-content">
                <div class="card">
                    <div class="loading-overlay" id="progress-loading">
                        <div class="spinner"></div>
                        <p class="loading-text">Regenerating health progress...</p>
                    </div>
                    <div class="card-header">
                        <h2 class="card-title">Health Progress Report</h2>
                        <button class="regenerate-btn" data-type="progress">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                            </svg>
                            Regenerate
                        </button>
                    </div>
                    <div id="progress-content"></div>
                </div>
            </div>
            
            <!-- Decision Tab -->
            <div id="decision-tab" class="tab-content">
                <div class="card">
                    <div class="loading-overlay" id="decision-loading">
                        <div class="spinner"></div>
                        <p class="loading-text">Regenerating decision analysis...</p>
                    </div>
                    <div class="card-header">
                        <h2 class="card-title">Clinical Decision Analysis</h2>
                        <button class="regenerate-btn" data-type="decision">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                            </svg>
                            Regenerate
                        </button>
                    </div>
                    <div id="decision-content"></div>
                </div>
            </div>
            
            <!-- Track Tab -->
            <div id="track-tab" class="tab-content">
                <div class="card">
                    <div class="loading-overlay" id="track-loading">
                        <div class="spinner"></div>
                        <p class="loading-text">Regenerating resource tracking...</p>
                    </div>
                    <div class="card-header">
                        <h2 class="card-title">Professional Time Tracking</h2>
                        <button class="regenerate-btn" data-type="track">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                            </svg>
                            Regenerate
                        </button>
                    </div>
                    <div id="track-content"></div>
                </div>
            </div>
            
            <div class="navigation">
                <button id="back-btn" class="nav-btn back-btn">Upload New Chat</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const backBtn = document.getElementById('back-btn');
            const regenerateButtons = document.querySelectorAll('.regenerate-btn');
            const loadingOverlays = document.querySelectorAll('.loading-overlay');
            
            // Store raw response data
            let rawResponseData = {};
            
            // Tab switching functionality
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show active tab content
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabId}-tab`) {
                            content.classList.add('active');
                        }
                    });
                });
            });
            
            // Back button handler
            backBtn.addEventListener('click', function() {
                window.location.href = 'index.html';
            });
            
            // Regenerate button handlers
            regenerateButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    regenerateContent(type);
                });
            });
            
            // Load data from localStorage
            const responseData = JSON.parse(localStorage.getItem('responseData'));
            
            if (responseData) {
                rawResponseData = responseData;
                parseAndDisplayContent('persona', responseData.persona);
                parseAndDisplayContent('progress', responseData.progress);
                parseAndDisplayContent('decision', responseData.decision);
                parseAndDisplayContent('track', responseData.track);
            } else {
                console.error('No response data found in localStorage');
                displayError();
            }
            
            // Function to regenerate specific content
            function regenerateContent(type) {
                // Show loading overlay
                document.getElementById(`${type}-loading`).classList.add('active');
                
                // Call the appropriate API endpoint
                fetch(`/${type}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ dummy: "data" })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(data => {
                    // Store the new response data
                    rawResponseData[type] = data;
                    localStorage.setItem('responseData', JSON.stringify(rawResponseData));
                    
                    // Parse and display the new content
                    parseAndDisplayContent(type, data);
                    
                    // Hide loading overlay
                    document.getElementById(`${type}-loading`).classList.remove('active');
                })
                .catch(error => {
                    console.error(`Error regenerating ${type}:`, error);
                    alert(`Error regenerating ${type}. Please try again.`);
                    document.getElementById(`${type}-loading`).classList.remove('active');
                });
            }

            function parseAndDisplayContent(type, content) {
                if (!content) {
                    document.getElementById(`${type}-content`).innerHTML = `<p>No ${type} data available.</p>`;
                    return;
                }

                // Clean up content - remove "\n" or "/n"
                const cleanedContent = content.replace(/\\n/g, '').replace(/\/n/g, '');
                
                // Skip metadata - extract only the HTML part
                const extractHTML = (content) => {
                    // Try to find the start of HTML content by looking for common tags
                    const startTags = ['<div', '<table', '<h1', '<h2', '<h3', '<p>'];
                    let startIndex = -1;
                    
                    for (const tag of startTags) {
                        const index = content.indexOf(tag);
                        if (index !== -1 && (startIndex === -1 || index < startIndex)) {
                            startIndex = index;
                        }
                    }
                    
                    // If no HTML tags found, return the original content
                    if (startIndex === -1) return content;
                    
                    // Extract from startIndex to the end
                    return content.substring(startIndex);
                };
                
                // Extract only the HTML part
                const htmlContent = extractHTML(cleanedContent);
                
                switch(type) {
                    case 'persona':
                        displayPersonaContent(htmlContent);
                        break;
                    case 'progress':
                        displayProgressContent(htmlContent);
                        break;
                    case 'decision':
                        displayDecisionContent(htmlContent);
                        break;
                    case 'track':
                        displayTrackContent(htmlContent);
                        break;
                }
            }
            
            // Display persona content as accordion
            function displayPersonaContent(content) {
                const contentElement = document.getElementById('persona-content');
                contentElement.innerHTML = '';
                
                // Get month data using regex
                const monthRegex = /\*\*Month\s+(\d+)\s+–\s+([^*]+)\*\*\s+<div[^>]*>([\s\S]*?)<\/div>/g;
                let match;
                
                let monthCount = 0;
                
                while ((match = monthRegex.exec(content)) !== null) {
                    monthCount++;
                    const monthNumber = match[1];
                    const monthTitle = match[2].trim();
                    const monthContent = match[3];
                    
                    // Extract data from month content
                    const goalMatch = /<p><b>1\) Primary Goal\/Trigger:<\/b>\s*(.*?)<\/p>/i.exec(monthContent);
                    const triggeredMatch = /<p><b>2\) Triggered by Whom:<\/b>\s*(.*?)<\/p>/i.exec(monthContent);
                    const frictionMatch = /<p><b>3\) Friction Points:<\/b>\s*(.*?)<\/p>/i.exec(monthContent);
                    const outcomeMatch = /<p><b>4\) Final Outcome:<\/b>\s*(.*?)<\/p>/i.exec(monthContent);
                    const beforeStateMatch = /<li><b>Before State:<\/b>\s*(.*?)<\/li>/i.exec(monthContent);
                    const afterStateMatch = /<li><b>After State:<\/b>\s*(.*?)<\/li>/i.exec(monthContent);
                    
                    const goal = goalMatch ? goalMatch[1] : 'Not available';
                    const triggered = triggeredMatch ? triggeredMatch[1] : 'Not available';
                    const friction = frictionMatch ? frictionMatch[1] : 'Not available';
                    const outcome = outcomeMatch ? outcomeMatch[1] : 'Not available';
                    const beforeState = beforeStateMatch ? beforeStateMatch[1] : 'Not available';
                    const afterState = afterStateMatch ? afterStateMatch[1] : 'Not available';
                    
                    // Create accordion item
                    const accordionItem = document.createElement('div');
                    accordionItem.className = 'month-accordion';
                    accordionItem.innerHTML = `
                        <div class="month-header" onclick="toggleAccordion(this, ${monthNumber})">
                            <div>Month ${monthNumber} – ${monthTitle}</div>
                            <svg class="month-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                        <div class="month-content" id="month-content-${monthNumber}">
                            <div class="detail-row">
                                <div class="detail-label">Primary Goal/Trigger</div>
                                <div class="detail-value">${goal}</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">Initiated By</div>
                                <div class="detail-value">${triggered}</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">Friction Points</div>
                                <div class="detail-value">${friction}</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">Final Outcome</div>
                                <div class="detail-value">${outcome}</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">Before State</div>
                                <div class="detail-value">${beforeState}</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">After State</div>
                                <div class="detail-value">${afterState}</div>
                            </div>
                        </div>
                    `;
                    
                    contentElement.appendChild(accordionItem);
                    
                    // Open first accordion by default
                    if (monthCount === 1) {
                        setTimeout(() => {
                            const firstHeader = contentElement.querySelector('.month-header');
                            if (firstHeader) firstHeader.click();
                        }, 100);
                    }
                }
                
                // If no months found, display the raw HTML
                if (monthCount === 0) {
                    // Try to extract the actual HTML content
                    contentElement.innerHTML = content;
                }
            }
            
            // Display progress content
            function displayProgressContent(content) {
                const contentElement = document.getElementById('progress-content');
                
                // Try to extract table data
                const tableRegex = /<table[^>]*>([\s\S]*?)<\/table>/i;
                const tableMatch = tableRegex.exec(content);
                
                if (tableMatch) {
                    // Create formatted table
                    const tableHTML = `
                        <h3>Health Status Progress</h3>
                        <table class="progress-table">
                            ${tableMatch[1].replace(/<tr/g, '<tr').replace(/<td/g, '<td').replace(/\/td>/g, '').replace(/background-color: #e6f7e6;/g, '')}
                        </table>
                    `;
                    
                    // Replace the status cell with formatted status
                    let formattedHTML = tableHTML.replace(/>Improved</g, '><span class="status-improved">Improved</span>');
                    
                    contentElement.innerHTML = formattedHTML;
                    
                    // Add proper classes to the table headers
                    const tableHeaders = contentElement.querySelectorAll('th');
                    tableHeaders.forEach(header => {
                        header.style.padding = '15px';
                    });
                } else {
                    // Display original content
                    contentElement.innerHTML = content;
                }
            }
            
            // Display decision content
            function displayDecisionContent(content) {
                const contentElement = document.getElementById('decision-content');
                
                // Try to extract decision data
                const decisionRegex = /<div[^>]*?>(?:\s*<h3[^>]*?>([^<]*)<\/h3>)?[\s\S]*?<b>Decision Type:<\/b>.*?<span[^>]*?>(.*?)<\/span>[\s\S]*?<b>Decision Details:<\/b>\s*(.*?)<\/p>[\s\S]*?<b>Reason:<\/b>\s*(.*?)<\/p>[\s\S]*?<\/div>/gi;
                let match;
                let count = 0;
                
                // Clear content first
                contentElement.innerHTML = '';
                
                while ((match = decisionRegex.exec(content)) !== null) {
                    count++;
                    const title = match[1] || `Decision ${count}`;
                    const type = match[2].trim();
                    const details = match[3].trim();
                    const reason = match[4].trim();
                    
                    // Determine badge class based on type
                    let badgeClass = 'badge-diagnostic';
                    if (type.toLowerCase().includes('nutrition')) badgeClass = 'badge-nutrition';
                    if (type.toLowerCase().includes('cardio')) badgeClass = 'badge-cardio';
                    if (type.toLowerCase().includes('medication')) badgeClass = 'badge-medication';
                    
                    // Create decision card
                    const decisionCard = document.createElement('div');
                    decisionCard.className = 'decision-card';
                    
                    decisionCard.innerHTML = `
                        <div class="decision-header">
                            <span class="decision-badge ${badgeClass}">${type}</span>
                            <h3 class="decision-title">${title}</h3>
                        </div>
                        
                        <div class="decision-details">
                            <div class="detail-row">
                                <div class="detail-label">Details</div>
                                <div class="detail-value">${details}</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">Reason</div>
                                <div class="detail-value">${reason}</div>
                            </div>
                        </div>
                        
                        <div class="timeline">
                            <div class="timeline-item">Symptom Onset</div>
                            <div class="timeline-item">Assessment</div>
                            <div class="timeline-item timeline-active">Decision</div>
                            <div class="timeline-item">Follow-up</div>
                        </div>
                    `;
                    
                    contentElement.appendChild(decisionCard);
                }
                
                // If no decisions found, display the raw HTML
                if (count === 0) {
                    contentElement.innerHTML = content;
                }
            }
            
            // Display track content
            function displayTrackContent(content) {
                const contentElement = document.getElementById('track-content');
                
                // Try to extract table data
                const tableRegex = /<table[^>]*>([\s\S]*?)<\/table>/i;
                const tableMatch = tableRegex.exec(content);
                
                if (tableMatch) {
                    // Create formatted table with enhanced styling
                    contentElement.innerHTML = `
                        <h3>Monthly Professional Time Tracking (Hours)</h3>
                        <div style="overflow-x: auto;">
                            <table class="track-table">
                                ${tableMatch[1].replace(/<tr/g, '<tr').replace(/<td/g, '<td')}
                            </table>
                        </div>
                    `;
                    
                    // Add formatting to total column
                    const totalCells = contentElement.querySelectorAll('td:last-child');
                    totalCells.forEach(cell => {
                        cell.classList.add('total-column');
                    });
                } else {
                    // Display original content
                    contentElement.innerHTML = content;
                }
            }
            
            // Handle error when no data is available
            function displayError() {
                ['persona', 'progress', 'decision', 'track'].forEach(type => {
                    const contentElement = document.getElementById(`${type}-content`);
                    contentElement.innerHTML = '<p class="error-message">No data available. Please go back and upload a chat file.</p>';
                });
            }
        });
        
        // Function to toggle accordion
        function toggleAccordion(header, monthNumber) {
            // Toggle header active class
            header.classList.toggle('month-header-active');
            
            // Toggle icon rotation
            const icon = header.querySelector('.month-toggle-icon');
            icon.classList.toggle('month-toggle-icon-active');
            
            // Toggle content visibility
            const content = document.getElementById(`month-content-${monthNumber}`);
            content.classList.toggle('month-content-active');
        }
    </script>
</body>
</html>